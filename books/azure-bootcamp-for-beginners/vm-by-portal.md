---
title: "Azure Portalを使って、ブラウザからVMを起動する" # 記事のタイトル
published: false # 公開設定（falseにすると下書き）
---

# VMを起動しよう

この章では、Azureのポータル（Web画面）を使って、VMを起動してWebサーバーを動かしてみます。（画面操作は2022年8月時点のものです）

## 準備：リソースグループ

AuzreではVMなどの色々なサービスの要素（リソース）をまとめて管理する仕組みとして「リソースグループ」を使います。

今回の実験のために、まずリソースグループを作りましょう。

### ポータルからリソースグループを作成

- [Azure Potarl](https://portal.azure.com/) にサインイン
- 「リソースグループ」で検索し、リソースグループのページに移動
- [+新規]をクリック

![新規リソース](/images/azure_resouce_group_head.png)

- リソースグループの新規作成画面が表示されるので、次の項目を指定
  - サブスクリプションを選択 ... 課金単位をまとめるもの
    - アカウント作成時に作っているはず。複数ある場合は今回利用するものを選択
  - リソースグループ ... 今回作る任意の名前を指定
    - この例では「_myVMgroup_」を指定。今後自分の指定した名前に読み替えてください
  - リージョン ... リソースを作成する地域。好みの地域を選択
    - この例では「Japan East」を指定

![リソースグループの内容](/images/azure_new_resource_group.png)

- 画面の下の[確認および作成]ボタンをクリック
- 確認画面で内容を確認し、OKなら下の[作成]ボタンをクリック
- リソースグループの一覧画面に戻る
  - 指定した「_myVMgroup_」が一覧に存在するのを確認

この後のリソース(VM等)は、今回用意したリソースグループ「_myVMgroup_」に作ります。

## VMの起動

次にポータルからVMを作成します。

### ポータルからVMの作成

- ポータルで「Virtual Machines」を検索し、Virtual Machinesのページに移動
- [+新規]をクリック
  - 出てきたメニューから[Azure 仮想マシン]をクリック

![新規VMメニュー](/images/azure_vm_menu.png)

### 基本内容の指定

- 「仮想マシンの作成」画面が表示されるので、次の項目を指定
  - サプスクリプション
  - リソースグループ ... 準備で作成したリソースグループを選択（ _myVMgroup_ など）
  - 仮想マシン名 ... 作成するVMの名前。任意に指定（例えば _firstVM_ など）
  - 地域 ... Japan Eastなど
  - イメージ ... OSの種類。今回は「Ubuntu Server 20.04LTS - Gen2」を選択

![新規VM指定1](/images/azure_new_vm_panel1.png)

- 続き
  - サイズ ... VMのサイズ。今回は「Standard_B1ls - 1 vcpu、0.5GiB のメモリ」を選択
  - 管理者アカウントの設定はそのまま
    - 認証の種類 ... SSH公開キー
    - ユーザー名 ... azureuser
    - SSH公開キーのソース ... 新しいキーの組みの生成
    - キーの組名 ... この例では「_firstVM_key_」

![新規VM指定2](/images/azure_new_vm_panel2.png)

- さらに続き
  - 受信ポートの規則はそのまま（sshでの接続を許可する）
    - パブリック受信ポート ... 選択したポートを許可する
    - 受信ポートを選択 ... SSH(22)
- 下の[次：ディスク]ボタンをクリック

### ディスクの指定

- OSディスクの種類 ... (1ランク下げて)「Standard SSD」を選択
- データディスク ... 追加しない（そのまま）
- 下の[次：ネットワーク]ボタンをクリック

![新規VMディスク](/images/azure_new_vm_disk_panel.png)

### ネットワークの指定

- 内容はデフォルトのまま（sshの接続を許可する）
- 下の[確認および作成]ボタンをクリック

![新規VMネットワーク](/images/azure_new_vm_network_panel.png)

### 確認と作成

- 指定内容を確認したら、[作成]ボタンをクリック

![新規VM確認](/images/azure_new_vm_confirm_panel.png)

- 「新しいキーの組の生成」ダイアログが表示される
  - [秘密キーのダウンロードとリソースの作成]ボタンをクリック
- ブラウザーで秘密キーのファイルがダウンロードされる
  - この例では「firstVM_key.pem」
  - 後で利用するので、適切なディレクトリに移動
    - MacやLinuxの場合はユーザのホームの直下の「.ssh」フォルダなど（~/.ssh/）
    - Windowsの場合もホームディレクトリの下に「.ssh」フォルダを作って移動
- デプロイが開始
  - 数十秒かかる
  - 完了すると[リソースに移動]ボタンが表示されるので、クリック
- 作成されたVMの概要が表示される
  - 「パブリック IP アドレス」の値を記録しておく（この後で利用するため）

![VM情報](/images/azure_vm_basic_info.png)

## VMに接続

起動したVMに、sshやターミナルエミュレーターで接続します。

### MacやLinuxの場合

ターミナルを開き、次のように秘密キーのパーミッション（アクセス権限）を変更してから、sshで接続します。

```
chmod 600  ~/.ssh/firstVM_key.pem

ssh -i ~/.ssh/firstVM_key.pem azureuser@xxx.xxx.xxx.xxx
```

- _~/.ssh/firstVM_key.pem_ の部分は、実際に保存した秘密キーのパスを指定
- _xxx.xxx.xxx.xxx_ の部分は、先ほど記録した「パブリック IP アドレス」を指定
- 初回に接続する際には、「接続先を信頼するか」「鍵ファイルを記録するか」等の確認メッセージが出るので、Yes/OKして進む


### Windowsの場合

コマンドプロンプト、またはPower Shellを開き、次の様にsshで接続します。

```
ssh -i C:\Users\username\.ssh\firstVM_key.pem azureuser@xxx.xxx.xxx.xxx
```

- _C:\Users\username\.ssh\firstVM_key.pem_ の部分は、実際に保存した秘密キーのパスを指定
- _xxx.xxx.xxx.xxx_ の部分は、先ほど記録した「パブリック IP アドレス」を指定
- 初回に接続の際に確認メッセージが出るので、Yes/OKして進む　（※実際のメッセージを確認）

あるいは、「[rlogin]()」等のターミナルエミュレーターを利用してもOKです。（秘密鍵ファイルを指定して接続）


## Webサーバー(nginx)のインストール

VMに接続できたら、その状態でWebサーバ([nginx](https://www.nginx.com/resources/wiki/))をインストールして動かします。
※手物とのマシン(Mac/Linux/Windows)ではなく、先ほど接続したVMに対して操作します。

### VMのパッケージを更新

```
sudo apt update
sudo apt upgrade
```

### nginxのインストール

```
sudo apt install nginx
ps -ef | grep nginx
```

ここでnginxのプロセスがいくつか表示されればOKです。

※図をいれる

### httpポートの公開

Azureの持つネットワークの保護機能により、このままではhttpポート(80/tcp)は外部からアクセスアクセスできません。そこで、ポータル画面がから明示的にアクセスを許可します。



